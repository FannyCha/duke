#################
# Usage:
#
# Targets:
#     dist     : full build & installation
#     tests    : run unit-test suite
#
# Options:
#     --no-<plugin>    : removes plugin <plugin> from build list
#
#################

import os ;
import set ;
using pb : $(PROTOC) ;

## Configuration

local				GIT_COMMIT			= [ modules.peek : GIT_COMMIT ] ; 
local 				GIT_BRANCH			= [ modules.peek : GIT_BRANCH ] ; 
local 				BUILD_NUMBER		= [ modules.peek : BUILD_NUMBER ] ;
local 				JAMDATE				= [ modules.peek : JAMDATE ] ;

local 				BOOST_ROOT 			= [ modules.peek : BOOST_ROOT ] ;
use-project /boost 						: $(BOOST_ROOT) ;
use-project /dukeapi                    : src/duke/libraries/dukeapi/dukeapi ;
use-project /dukeengine                 : src/duke/libraries/dukeengine/dukeengine ;
use-project /dukeioplugin               : src/duke/libraries/dukeio/dukeio/plugin ;
use-project /dukerendererplugin	        : src/duke/libraries/dukerenderer/plugin ;
use-project /duke/sub/dukeplugins		: src/duke/submodules/dukeplugins ;
use-project /duke/sub/sequence      	: src/duke/submodules/sequenceparser/src/sequence ;
use-project /duke/sub/sequenceparser	: src/duke/submodules/sequenceparser/src/sequence/parser ;
use-project /duke/sub/concurrent		: src/duke/submodules/concurrent_utils/src ;
use-project /dukexcore                  : src/dukex/libraries/dukexcore ;
use-project /dukexgui                   : src/dukex/libraries/dukexgui ;

project : requirements
            <threading>multi
            <toolset>gcc:<cxxflags>-isystem$(BOOST_ROOT)		# will prevent warnings within boost
#            <toolset>gcc:<cxxflags>-fvisibility=hidden			# hidding export by default
#            <toolset>gcc:<cxxflags>-fvisibility-inlines-hidden	# hidding export by default
            <os>NT:<define>WIN32_LEAN_AND_MEAN
            <os>NT:<define>VC_EXTRALEAN
            <os>NT:<define>_WIN32_WINNT=0x0501
            <variant>debug:<define>DEBUG
            <define>GIT_COMMIT=\"\\\"$(GIT_COMMIT)\\\"\"
            <define>GIT_BRANCH=\"\\\"$(GIT_BRANCH)\\\"\"
            <define>BUILD_NUMBER=\"\\\"$(BUILD_NUMBER)\\\"\"
            <define>JAMDATE=\"\\\"$(JAMDATE)\\\"\"
        : build-dir bin	;


## Main targets

explicit plugin-jpg
         plugin-dpx
         plugin-oiio
         plugin-ogl
         plugin-dx9
         plugin-timeline
         plugin-imageinfo
         dukeplugins
         duketests
         shader_prototypes
         mingw_runtime
         dukexplugins
         dukextests
         distduke
         distdukex
         dist 
         tests ;

alias plugin-jpg        : src/duke/plugins/io/jpg//jpg ;
alias plugin-dpx        : src/duke/plugins/io/dpx//dpx ;
alias plugin-oiio       : src/duke/plugins/io/oiio//oiio ;
alias plugin-ogl        : src/duke/plugins/renderer/ogl//ogl ;
alias plugin-dx9        : src/duke/plugins/renderer/dx9//dx9 ;
alias plugin-timeline   : src/dukex/plugins/timeline//timeline ;
alias plugin-imageinfo   : src/dukex/plugins/imageinfo//imageinfo ;
alias dukeplugins 		: plugin-jpg plugin-dpx plugin-oiio plugin-ogl : <os>LINUX ;
alias dukeplugins 		: plugin-jpg plugin-dpx plugin-oiio plugin-ogl : <os>MACOSX ;
alias dukeplugins 		: plugin-jpg plugin-dpx plugin-dx9 plugin-ogl : <os>NT ;
alias duketests 	    : src/duke/libraries//tests src/duke/submodules//tests ;
alias dukexplugins 		: plugin-timeline plugin-imageinfo ;
alias dukextests 	    : [ glob src/dukex/tests/* ] ;
alias tests 	        : duketests dukextests ;
alias mingw_runtime     ;
alias mingw_runtime     : /user-config//mwingw_runtime : <os>NT <toolset>gcc ;

install dist :
	    #src/diskbench
	    src/duke/app
	    src/dukex/app
	    dukeplugins
	    dukexplugins
	    mingw_runtime
    :
	    <install-dependencies>on
	    <install-type>SHARED_LIB
	    <install-type>SEARCHED_LIB
	    <install-type>EXE
	    <variant>debug:<location>dist/debug
	    <variant>release:<location>dist/release
    ;
    
install distduke :
	    #src/diskbench
	    src/duke/app
	    dukeplugins
	    mingw_runtime
    :
	    <install-dependencies>on
	    <install-type>SHARED_LIB
	    <install-type>SEARCHED_LIB
	    <install-type>EXE
	    <variant>debug:<location>dist/debug
	    <variant>release:<location>dist/release
    ;

install distdukex :
	    src/dukex/app
	    dukexplugins
	    mingw_runtime
    :
	    <install-dependencies>on
	    <install-type>SHARED_LIB
	    <install-type>SEARCHED_LIB
	    <install-type>EXE
	    <variant>debug:<location>dist/debug
	    <variant>release:<location>dist/release
    ;
