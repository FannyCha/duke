#################
# Usage:
#
# Targets:
#     dist     : full build & installation
#     tests    : run unit-test suite
#
# Options:
#     --no-<plugin>    : removes plugin <plugin> from build list
#
#################

import os ;
import set ;
using pb : $(PROTOC) ;

## Configuration

local 				BOOST_ROOT 			= [ modules.peek : BOOST_ROOT ] ;
use-project /boost 						: $(BOOST_ROOT) ;
use-project /dukeapi                    : src/duke/libraries/dukeapi ;
use-project /dukeengine                 : src/duke/libraries/dukeengine ;
use-project /dukeioplugin               : src/duke/libraries/dukeio/dukeio/plugin ;
use-project /dukerendererplugin	        : src/duke/libraries/dukerenderer/plugin ;
use-project /duke/sub/dukeplugins		: src/duke/submodules/dukeplugins ;
use-project /duke/sub/sequence      	: src/duke/submodules/sequenceparser/src/sequence ;
use-project /duke/sub/sequenceparser	: src/duke/submodules/sequenceparser/src/sequence/parser ;
use-project /dukexcore                  : src/dukex/libraries/dukexcore ;
use-project /dukexgui                   : src/dukex/libraries/dukexgui ;

project : requirements
            <threading>multi
            <toolset>gcc:<cxxflags>-isystem$(BOOST_ROOT) # will prevent warnings within boost
            <os>NT:<define>WIN32_LEAN_AND_MEAN
            <os>NT:<define>VC_EXTRALEAN
            <os>NT:<define>_WIN32_WINNT=0x0501
        : build-dir bin	;


## Main targets

explicit plugin-jpg
         plugin-dpx
         plugin-oiio
         plugin-ogl
         plugin-dx9
         plugin-timeline
         dukeplugins
         duketests
         shader_prototypes
         mingw_runtime
         dukexplugins
         dukextests
         distduke
         distdukex
         dist 
         tests ;

alias plugin-jpg        : src/duke/plugins/io/jpg//jpg ;
alias plugin-dpx        : src/duke/plugins/io/dpx//dpx ;
alias plugin-oiio       : src/duke/plugins/io/oiio//oiio ;
alias plugin-ogl        : src/duke/plugins/renderer/ogl//ogl ;
alias plugin-dx9        : src/duke/plugins/renderer/dx9//dx9 ;
alias plugin-timeline   : src/dukex/plugins/timeline//timeline ;
alias dukeplugins 		: plugin-jpg plugin-dpx plugin-oiio plugin-ogl : <os>LINUX ;
alias dukeplugins 		: plugin-jpg plugin-dpx plugin-oiio plugin-ogl : <os>MACOSX ;
alias dukeplugins 		: plugin-jpg plugin-dpx plugin-dx9 plugin-ogl : <os>NT ;
alias duketests 	    : [ glob src/duke/tests/* : src/duke/tests/renderer src/duke/tests/scripts ] ;
alias dukexplugins 		: plugin-timeline ;
alias dukextests 	    : [ glob src/dukex/tests/* ] ;
alias tests 	        : duketests dukextests ;
alias mingw_runtime     ;
alias mingw_runtime     : /user-config//mwingw_runtime : <os>NT <toolset>gcc ;

install shader_prototypes :
    [ glob src/duke/resources/shader_prototypes/* ]
    :
    <variant>debug:<location>dist/debug/shader_prototypes
    <variant>release:<location>dist/release/shader_prototypes
    ;

install dist :
    #src/diskbench//diskbench
    src/duke//duke
    src/dukex//dukex
    dukeplugins
    dukexplugins
    mingw_runtime
    :
    <install-dependencies>on
    <install-type>SHARED_LIB
    <install-type>SEARCHED_LIB
    <install-type>EXE
    <variant>debug:<location>dist/debug
    <variant>release:<location>dist/release
    <dependency>shader_prototypes
    ;
    
install distduke :
    #src/diskbench//diskbench
    src/duke//duke
    dukeplugins
    mingw_runtime
    :
    <install-dependencies>on
    <install-type>SHARED_LIB
    <install-type>SEARCHED_LIB
    <install-type>EXE
    <variant>debug:<location>dist/debug
    <variant>release:<location>dist/release
    <dependency>shader_prototypes
    ;

install distdukex :
    src/dukex//dukex
    dukexplugins
    mingw_runtime
    :
    <install-dependencies>on
    <install-type>SHARED_LIB
    <install-type>SEARCHED_LIB
    <install-type>EXE
    <variant>debug:<location>dist/debug
    <variant>release:<location>dist/release
    ;

