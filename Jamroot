
	#################
	# Usage:
	# 
	# Targets:
	#     dist     : full build & installation 
	#     tests    : run unit-test suite
	# 
	# Options:
	#     --no-<plugin>    : removes plugin <plugin> from build list
	#
	#################

		
import os ;
import set ;

## Project specific rules
 
local rule plugins-selection ( existing-plugins * ) {
	local argv = [ modules.peek : ARGV ] ;
	local no-parameter = [ MATCH --no-(.*) : $(argv) ] ;
	local wrong = [ set.difference $(no-parameter) : $(existing-plugins) ] ;
	if $(wrong)	{
		ECHO "error: wrong plugin name '$(wrong[1])' in the --no-<plugin> option." ;
		EXIT ;
	}
	return [ set.difference $(existing-plugins) : $(no-parameter) ] ;
}
local rule check-required-env ( var ) {
	if ! $($(var)) {
		EXIT Missing variable $(var) ;
	}
}


## Configuration

local 				BOOST_ROOT 			= [ modules.peek : BOOST_ROOT ] ; 
check-required-env 	BOOST_ROOT ;

use-project /boost 						: $(BOOST_ROOT) ;
use-project /duke/lib/engine			: src/libraries/dukeengine ;
use-project /duke/lib/api				: src/libraries/dukeapi ;
use-project /duke/lib/io				: src/libraries/dukeio ;
use-project /duke/lib/ioplugin			: src/libraries/dukeio/plugin ;
use-project /duke/lib/renderer			: src/libraries/dukerenderer ;
use-project /duke/lib/rendererplugin	: src/libraries/dukerenderer/plugin ;
use-project /duke/sub/duke.plugins		: src/submodules/duke.plugins ;

project : requirements 
			<threading>multi
			<include>$(BOOST_ROOT)
			<toolset>gcc:<cxxflags>-std=gnu++0x
			<os>NT:<define>WIN32_LEAN_AND_MEAN
			<os>NT:<define>VC_EXTRALEAN
			<os>NT:<define>_WIN32_WINNT=0x0501
		: build-dir bin	;


## Main targets

explicit applications
		 plugins
		 tests
		 plugin-foo
		 dist ;

alias applications 	: src/applications/duke//duke ; # src/applications/diskbench//diskbench ;
alias plugins 		: [ plugins-selection plugin-jpg plugin-dpx plugin-oiio plugin-ogl ] : <os>LINUX ;
alias plugins 		: [ plugins-selection plugin-jpg plugin-dpx plugin-oiio plugin-ogl ] : <os>MACOSX ;
alias plugins 		: [ plugins-selection plugin-jpg plugin-dpx plugin-dx9 ] : <os>NT ;
alias tests 		: [ glob src/tests/* ] ;
alias plugin-jpg	: src/plugins/io/jpg//jpg ;
alias plugin-dpx	: src/plugins/io/dpx//dpx ;
alias plugin-oiio	: src/plugins/io/oiio//oiio ;
alias plugin-ogl	: src/plugins/renderer/ogl//ogl ;
alias plugin-dx9	: src/plugins/renderer/dx9//dx9 ;

install dist :
	applications
	plugins
	:
	 <install-dependencies>on 
	 <install-type>SHARED_LIB 
	 <install-type>SEARCHED_LIB 
	 <install-type>EXE
	 <variant>debug:<location>dist/debug
	 <variant>release:<location>dist/release
	;
